<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>ピタロジ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @font-face {
            font-family: 'DotGothic16';
            src: url('fonts/DotGothic16-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            background-color: black;
            overflow: hidden;
            font-family: sans-serif;
        }

        #bg-img {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            height: 100vh;
            width: auto;
            object-fit: contain;
            z-index: 0;
        }

        .app-wrapper {
            position: absolute;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 10px;
            padding-bottom: 10px;
            box-sizing: border-box;
        }

        #top-bar {
            width: 100%;
            display: flex;
            justify-content: flex-start;
            padding: 10px 15px;
            box-sizing: border-box;
        }

        .button {
            width: 40px;
            height: 40px;
            background: url("pictures/backBtn.png") no-repeat center center;
            background-size: contain;
            cursor: pointer;
            user-select: none;
        }

        #board-container {
            display: grid;
            margin: 10px 0 30px 0;
            grid-gap: 1px;
            justify-content: center;
            box-sizing: border-box;
        }

        .cell,
        .cell-number {
            display: flex;
            font-family: 'DotGothic16', sans-serif;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            border: 1px solid #fff;
            color: #fff;
            user-select: none;
            font-size: 24px;
            box-sizing: border-box;
        }

        .cell-number {
            background-color: #233B6C;
        }

        #cards-container-wrapper {
            width: 100%;
            overflow-x: auto;
        }

        #cards-container {
            display: flex;
            gap: 5px;
            padding: 0 5px;
            margin-bottom: 10px;
        }

        .card {
            aspect-ratio: 766/575;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            background: transparent;
            flex: 0 0 auto;
        }

        .card-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .card-label {
            font-family: 'DotGothic16', sans-serif;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -55%);
            font-weight: bold;
            font-size: 14px;
            color: black;
            text-shadow: 1px 1px 2px white;
            text-align: center;
            pointer-events: none;
            white-space: pre-line;
        }

        .card.selected {
            border: 3px solid yellow;
            transform: scale(1.05);
        }

        #reset-wrapper {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            justify-content: center;
            width: 200px;
        }

        #reset-button {
            width: 100%;
            height: 60px;
            border: none;
            background: url("pictures/re_Btn.png") no-repeat center center;
            background-size: contain;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-weight: bold;
            font-size: 16px;
        }

        #reset-button .reset-label {
            font-family: 'DotGothic16', sans-serif;
            position: relative;
            top: -3px;
        }

        #clear-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 20px;
            border: 2px solid #000;
            text-align: center;
            display: none;
            z-index: 200;
            width: 90%;
            max-width: 600px;
            box-sizing: border-box;
        }

        #clear-overlay p {
            font-size: 28px;
            margin: 10px 0;
        }

        #clear-overlay button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
        }

        /* ご褒美絵 */
        #reward-image {
            position: absolute;
            display: none;
            pointer-events: none;
            z-index: 150;
            opacity: 0;
            transition: opacity 2s ease;
        }

        @media (pointer: fine) {
            #cards-container-wrapper {
                overflow-x: auto;
            }
        }

        @media (pointer: coarse) {
            #cards-container-wrapper {
                overflow-x: hidden;
            }
        }
    </style>
</head>

<body>
    <img id="bg-img" src="bg/bg_play.png" alt="">
    <div class="app-wrapper">
        <div id="top-bar">
            <div id="back-button" class="button"></div>
        </div>

        <div id="board-container"></div>

        <div id="cards-container-wrapper">
            <div id="cards-container"></div>
        </div>

        <div id="reset-wrapper">
            <button id="reset-button"><span class="reset-label">リセット</span></button>
        </div>
    </div>

    <!-- ご褒美絵 -->
    <div id="reward-image"></div>

    <div id="clear-overlay">
        <p>ステージクリア！</p>
        <button id="next-stage">次のステージへ</button>
        <button id="to-select">ステージ選択へ戻る</button>
    </div>

    <script src="stages_contents.js"></script>
    <script>
        if (document.referrer.includes('start.html')) {
            localStorage.removeItem('stageClear');
        }

        const bgImg = document.getElementById('bg-img');
        const appWrapper = document.querySelector('.app-wrapper');

        function positionAppWrapper() {
            if (!bgImg.complete || bgImg.naturalWidth === 0) {
                bgImg.onload = () => requestAnimationFrame(positionAppWrapper);
                return;
            }
            const rect = bgImg.getBoundingClientRect();
            appWrapper.style.left = rect.left + 'px';
            appWrapper.style.top = rect.top + 'px';
            appWrapper.style.width = rect.width + 'px';
            appWrapper.style.height = rect.height + 'px';
            if (typeof resizeBoard === 'function') resizeBoard();
            resizeCards();
        }

        function resizeCards() {
            const rect = bgImg.getBoundingClientRect();
            const cardWidth = rect.width * 0.28;
            const cardsContainer = document.getElementById('cards-container');
            const wrapper = document.getElementById('cards-container-wrapper');
            const cards = document.querySelectorAll('.card');

            cards.forEach(card => {
                card.style.width = cardWidth + 'px';
                card.style.flex = `0 0 ${cardWidth}px`;
            });

            if (cards.length === 3) {
                cardsContainer.style.justifyContent = 'center';
                wrapper.style.overflowX = 'hidden';
            } else {
                cardsContainer.style.justifyContent = 'flex-start';
                wrapper.style.overflowX = 'auto';
            }
        }

        window.addEventListener('resize', () => {
            clearTimeout(window._bgPosTimer);
            window._bgPosTimer = setTimeout(positionAppWrapper, 50);
        });
        positionAppWrapper();

        let stageId = parseInt(new URLSearchParams(window.location.search).get("id") || 0);
        const stage = (typeof stages !== 'undefined') ? stages.find(s => s.id === stageId) : null;

        if (!stage) {
            document.getElementById('board-container').textContent = 'ステージ情報が見つかりません';
        } else {
            const rows = parseInt(stage.size.split('x')[0]);
            const cols = parseInt(stage.size.split('x')[1]);
            let board = JSON.parse(JSON.stringify(stage.question));
            let selectedCard = null;
            let usedCards = new Set();
            const boardContainer = document.getElementById('board-container');

            function resizeBoard() {
                const rect = bgImg.getBoundingClientRect();
                const availableWidth = rect.width;
                const availableHeight = rect.height;
                const cellSize = Math.max(24, Math.floor(Math.min(
                    (availableWidth * 0.9) / (cols + 1),
                    (availableHeight * 0.6) / (rows + 1)
                )));
                boardContainer.style.gridTemplateColumns = `repeat(${cols + 1}, ${cellSize}px)`;
                boardContainer.style.gridAutoRows = `${cellSize}px`;
            }

            function renderBoard() {
                resizeBoard();
                boardContainer.innerHTML = '';
                for (let r = -1; r < rows; r++) {
                    for (let c = -1; c < cols; c++) {
                        const div = document.createElement('div');
                        if (r === -1 && c === -1) div.className = 'cell-number';
                        else if (r === -1) { div.className = 'cell-number'; div.dataset.col = c; div.textContent = c + 1; }
                        else if (c === -1) { div.className = 'cell-number'; div.dataset.row = r; div.textContent = r + 1; }
                        else {
                            div.className = 'cell';
                            const isGoal = stage.goal[r][c];
                            div.style.backgroundColor = isGoal ? '#b4b4b4' : '#fff';
                            div.textContent = board[r][c];
                            div.style.color = board[r][c] !== stage.goal[r][c] ? '#e94709' : 'black';
                        }
                        boardContainer.appendChild(div);
                    }
                }
                addRowColListeners();
            }

            function renderCards() {
                const cardsContainer = document.getElementById('cards-container');
                cardsContainer.innerHTML = '';

                // 盤面サイズに応じた文字サイズ
                let labelFontSize = 20; 
                if (rows === 12 && cols === 12) {
                    labelFontSize = 16;
                } else if (rows === 16 && cols === 16) {
                    labelFontSize = 13;
                }

                stage.cards.forEach((card, idx) => {
                    const div = document.createElement('div');
                    div.className = 'card';
                    div.dataset.index = idx;
                    if (selectedCard === idx) div.classList.add('selected');
                    if (usedCards.has(idx)) { div.style.opacity = 0.5; div.style.pointerEvents = 'none'; }

                    let imgSrc = '';
                    if (card.type === 'NOT') imgSrc = 'pictures/not_Btn.png';
                    if (card.type === 'OR') imgSrc = 'pictures/or_Btn.png';
                    if (card.type === 'AND') imgSrc = 'pictures/and_Btn.png';
                    if (card.type === 'XOR') imgSrc = 'pictures/xor_Btn.png';

                    const img = document.createElement('img');
                    img.src = imgSrc;
                    img.className = 'card-img';
                    div.appendChild(img);

                    const label = document.createElement('span');
                    label.className = 'card-label';
                    label.style.fontSize = labelFontSize + 'px';
                    label.textContent = (card.type !== 'NOT' && card.sequence)
                        ? `${card.type}\n${card.sequence.join('')}` : card.type;
                    div.appendChild(label);

                    div.addEventListener('click', () => { selectedCard = idx; renderCards(); });
                    cardsContainer.appendChild(div);
                });
                resizeCards();
            }


            function addRowColListeners() {
                document.querySelectorAll('.cell-number').forEach(cell => {
                    const isRow = cell.dataset.row !== undefined;
                    const isCol = cell.dataset.col !== undefined;
                    cell.addEventListener('mouseenter', () => {
                        if (selectedCard === null) return;
                        if (isRow) {
                            const r = parseInt(cell.dataset.row);
                            for (let c = 0; c < cols; c++) boardContainer.children[(r + 1) * (cols + 1) + c + 1].style.backgroundColor = '#ff0';
                        } else if (isCol) {
                            const c = parseInt(cell.dataset.col);
                            for (let r = 0; r < rows; r++) boardContainer.children[(r + 1) * (cols + 1) + c + 1].style.backgroundColor = '#ff0';
                        }
                    });
                    cell.addEventListener('mouseleave', () => renderBoard());
                    cell.addEventListener('click', () => {
                        if (selectedCard === null) return;
                        const card = stage.cards[selectedCard];
                        if (isRow) {
                            const r = parseInt(cell.dataset.row);
                            for (let c = 0; c < cols; c++) applyCard(card, r, c, 'row');
                        } else if (isCol) {
                            const c = parseInt(cell.dataset.col);
                            for (let r = 0; r < rows; r++) applyCard(card, r, c, 'col');
                        }
                        usedCards.add(selectedCard);
                        selectedCard = null;
                        renderBoard();
                        renderCards();
                        checkClear();
                    });
                });
            }

            function applyCard(card, r, c, type) {
                if (card.type === 'NOT') board[r][c] = board[r][c] ? 0 : 1;
                if (card.type === 'OR' && card.sequence) board[r][c] = board[r][c] | (type === 'row' ? card.sequence[c] : card.sequence[r]);
                if (card.type === 'AND' && card.sequence) board[r][c] = board[r][c] & (type === 'row' ? card.sequence[c] : card.sequence[r]);
                if (card.type === 'XOR' && card.sequence) board[r][c] = board[r][c] ^ (type === 'row' ? card.sequence[c] : card.sequence[r]);
            }

            function checkClear() {
                let cleared = true;
                for (let r = 0; r < rows; r++) for (let c = 0; c < cols; c++) if (board[r][c] !== stage.goal[r][c]) cleared = false;
                if (cleared) showRewardImage(() => showClearOverlay());
            }

            function showRewardImage(callback) {
                const rect = boardContainer.getBoundingClientRect();
                const cellSize = boardContainer.querySelector('.cell')?.getBoundingClientRect().width || 0;

                const boardWidth = rect.width - cellSize;
                const boardHeight = rect.height - cellSize;
                const boardLeft = rect.left + cellSize;
                const boardTop = rect.top + cellSize;

                const rewardDiv = document.getElementById("reward-image");
                rewardDiv.style.left = boardLeft + "px";
                rewardDiv.style.top = boardTop + "px";
                rewardDiv.style.width = boardWidth + "px";
                rewardDiv.style.height = boardHeight + "px";

                rewardDiv.innerHTML = `<img src="${stage.clearImage}" alt="reward" style="width:100%;height:100%;object-fit:contain;">`;
                rewardDiv.style.display = "block";
                rewardDiv.style.opacity = 0;

                requestAnimationFrame(() => {
                    rewardDiv.style.opacity = 1;
                });

                setTimeout(callback, 2000 + 1000);
            }


            function showClearOverlay() {
                let totalStages = 14;
                let stageClear = JSON.parse(localStorage.getItem('stageClear')) || Array(totalStages).fill(false);
                stageClear[stageId] = true;
                localStorage.setItem('stageClear', JSON.stringify(stageClear));

                document.getElementById('back-button').style.pointerEvents = 'none';
                const overlay = document.getElementById('clear-overlay');
                overlay.style.display = 'block';

                const rewardDiv = document.getElementById("reward-image");

                document.getElementById('next-stage').style.display = (stageId >= 12) ? 'none' : 'inline-block';
                document.getElementById('next-stage').onclick = () => {
                    rewardDiv.style.display = "none";
                    window.location.href = `game.html?id=${stageId + 1}`;
                };

                document.getElementById('to-select').onclick = () => {
                    rewardDiv.style.display = "none";
                    window.location.href = 'stage_select.html';
                };

                if (stageId >= 12) setTimeout(() => {
                    rewardDiv.style.display = "none";
                    window.location.href = 'stage_select.html';
                }, 5000);
            }

            document.getElementById('back-button').addEventListener('click', () => {
                window.location.href = 'stage_select.html';
            });

            document.getElementById('reset-button').addEventListener('click', () => {
                board = JSON.parse(JSON.stringify(stage.question));
                usedCards.clear();
                selectedCard = null;
                renderBoard();
                renderCards();
            });

            setTimeout(() => { renderBoard(); renderCards(); }, 200);
        }
    </script>
</body>

</html>